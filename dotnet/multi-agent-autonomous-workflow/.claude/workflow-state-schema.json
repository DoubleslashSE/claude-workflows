{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "workflow-state-schema.json",
  "title": "Multi-Agent Workflow State",
  "description": "Schema for tracking autonomous workflow state across sessions",
  "type": "object",
  "required": ["workflowId", "goal", "status", "currentPhase", "stories"],
  "properties": {
    "workflowId": {
      "type": "string",
      "description": "Unique identifier for this workflow instance",
      "pattern": "^[a-f0-9]{8}$"
    },
    "sessionId": {
      "type": "string",
      "description": "Claude session ID for resumability"
    },
    "startedAt": {
      "type": "string",
      "format": "date-time",
      "description": "When the workflow was initiated"
    },
    "lastUpdated": {
      "type": "string",
      "format": "date-time",
      "description": "Last state modification timestamp"
    },
    "completedAt": {
      "type": "string",
      "format": "date-time",
      "description": "When the workflow completed (if applicable)"
    },
    "goal": {
      "type": "string",
      "description": "Original goal/feature request from user",
      "minLength": 1
    },
    "status": {
      "type": "string",
      "enum": ["in_progress", "completed", "blocked", "cancelled"],
      "description": "Overall workflow status"
    },
    "currentPhase": {
      "type": "string",
      "enum": ["analysis", "design", "implementation", "testing", "review", "deployment"],
      "description": "Current workflow phase"
    },
    "currentAgent": {
      "type": "string",
      "enum": ["orchestrator", "analyst", "architect", "developer", "tester", "reviewer", "devops"],
      "description": "Currently active agent"
    },
    "stories": {
      "type": "array",
      "description": "User stories for this workflow",
      "items": {
        "type": "object",
        "required": ["id", "title", "status"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^S\\d+$",
            "description": "Story identifier (S1, S2, etc.)"
          },
          "title": {
            "type": "string",
            "description": "Story title"
          },
          "size": {
            "type": "string",
            "enum": ["S", "M", "L", "XL"],
            "description": "Relative size estimate"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "in_progress", "testing", "review", "completed", "blocked"],
            "description": "Story status"
          },
          "acceptanceCriteria": {
            "type": "array",
            "items": { "type": "string" },
            "description": "Testable acceptance criteria"
          },
          "assignedAgent": {
            "type": ["string", "null"],
            "description": "Agent currently working on story"
          },
          "attempts": {
            "type": "integer",
            "minimum": 0,
            "description": "Number of implementation attempts"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "lastUpdated": {
            "type": "string",
            "format": "date-time"
          },
          "completedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "decisions": {
      "type": "array",
      "description": "Architecture Decision Records",
      "items": {
        "type": "object",
        "required": ["id", "title", "choice"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^ADR-\\d{3}$",
            "description": "Decision identifier"
          },
          "title": {
            "type": "string",
            "description": "Decision topic"
          },
          "choice": {
            "type": "string",
            "description": "What was decided"
          },
          "rationale": {
            "type": "string",
            "description": "Why this choice was made"
          },
          "date": {
            "type": "string",
            "format": "date"
          },
          "status": {
            "type": "string",
            "enum": ["proposed", "accepted", "deprecated", "superseded"],
            "default": "accepted"
          }
        }
      }
    },
    "checkpoints": {
      "type": "object",
      "description": "Human review checkpoint tracking",
      "properties": {
        "lastHumanReview": {
          "type": "string",
          "format": "date-time",
          "description": "Last human checkpoint"
        },
        "storiesSinceReview": {
          "type": "integer",
          "minimum": 0,
          "description": "Stories completed since last review"
        },
        "failedAttempts": {
          "type": "integer",
          "minimum": 0,
          "description": "Consecutive failed attempts"
        }
      }
    },
    "blockers": {
      "type": "array",
      "description": "Current blockers requiring human intervention",
      "items": {
        "type": "object",
        "required": ["description"],
        "properties": {
          "description": {
            "type": "string"
          },
          "severity": {
            "type": "string",
            "enum": ["low", "medium", "high", "critical"]
          },
          "createdAt": {
            "type": "string",
            "format": "date-time"
          },
          "resolved": {
            "type": "boolean",
            "default": false
          },
          "resolvedAt": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "metrics": {
      "type": "object",
      "description": "Quality and progress metrics",
      "properties": {
        "storiesCompleted": {
          "type": "integer",
          "minimum": 0
        },
        "storiesFailed": {
          "type": "integer",
          "minimum": 0
        },
        "avgAttemptsPerStory": {
          "type": "number"
        },
        "totalTestsWritten": {
          "type": "integer",
          "minimum": 0
        },
        "totalLinesChanged": {
          "type": "integer",
          "minimum": 0
        },
        "reviewFindings": {
          "type": "object",
          "properties": {
            "critical": { "type": "integer", "minimum": 0 },
            "warnings": { "type": "integer", "minimum": 0 },
            "suggestions": { "type": "integer", "minimum": 0 }
          }
        },
        "securityFindings": {
          "type": "object",
          "properties": {
            "critical": { "type": "integer", "minimum": 0 },
            "high": { "type": "integer", "minimum": 0 },
            "medium": { "type": "integer", "minimum": 0 },
            "low": { "type": "integer", "minimum": 0 }
          }
        },
        "coveragePercentage": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        }
      }
    },
    "contextSummary": {
      "type": "object",
      "description": "Context preserved for multi-hour sessions",
      "properties": {
        "keyDecisions": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Important decisions made during workflow"
        },
        "completedPatterns": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Patterns successfully implemented"
        },
        "openConcerns": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Issues to revisit later"
        },
        "lessonsLearned": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Insights from this workflow"
        },
        "lastProgressReport": {
          "type": "string",
          "format": "date-time",
          "description": "When last progress report was generated"
        }
      }
    },
    "fileChanges": {
      "type": "array",
      "description": "Track files changed per story for rollback",
      "items": {
        "type": "object",
        "properties": {
          "storyId": { "type": "string" },
          "files": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "path": { "type": "string" },
                "action": { "type": "string", "enum": ["created", "modified", "deleted"] }
              }
            }
          }
        }
      }
    }
  }
}
